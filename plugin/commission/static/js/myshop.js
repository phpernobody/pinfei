// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('1J([\'e\',\'z\',\'1M/4/I\'],3(e,z,I){6 1Q={12:\'\',13:\'\',14:\'\',15:\'\',11:\'\',1N:\'\',16:\'\',18:\'\',1g:\'\',1b:\'R\'};6 2={q:1,J:{},c:0,A:1,T:1D};2.1E=3(){$(\'.u-M\').M({1H:e.E(\'1s/M\'),C:t,1V:\'1v 1v-1I\',1F:e.E(\'1s/M/C\')});$(\'.d-1h\').m(3(){6 d=$(a);7(d.F(\'c\')){s}6 i=d.i();6 H=$(\'#1L\').W(\'1p:1x-1C\');6 G=$(\'#1R\').W(\'1p:1x-1C\');6 5={1O:$(\'#1P\').17(),R:$(\'#R\').17(),H:H.f>0?H.5(\'1j\'):\'\',G:G.f>0?G.5(\'1j\'):\'\'};d.F(\'c\',1).i(\'正在处理...\');e.O(\'y/U/1U\',{1T:5},3(x){7(x.1i==0){d.1l(\'c\').i(i);S.Z.o(x.b.1f);s}1a.1c=e.E(\'y\')},t,t)})};2.1W=3(){$(\'#10\').1K(3(){6 $a=$(a);7($a.v(\'p\')){$(\'#1e\').o()}r{$(\'#1e\').w()}});$(\'.k\').1y();$(\'.1G 1S\').m(3(){$(\'.k\').n(\'Q\');6 9=$(a);9.2b().2h("1d");9.2g("1d");$(\'.4-j-l\').i(\'\');2.J={15:9.5(\'15\')||\'\',14:9.5(\'14\')||\'\',13:9.5(\'13\')||\'\',11:9.5(\'11\')||\'\',12:$(\'#12\').17(),16:9.5(\'16\')||\'\',18:9.5(\'18\')||\'\',2f:0,1g:"",1b:""};2.q=1,2.c=0;2.K()});$(\'.d-1h\').m(3(){6 d=$(a);7(d.F(\'c\')){s}6 i=d.i();6 B=[];$(".4-h").1B(3(){B.2d($(a).5(\'8\'))});7(B.f<=0&&$(\'#10\').v(\'p\')){S.Z.o(\'请选择商品!\');s}6 5={2e:$(\'#10\').v(\'p\')?1:0,2j:$(\'#2i\').v(\'p\')?1:0,B:B};d.F(\'c\',1).i(\'正在处理...\');e.O(\'y/U/2n\',5,3(x){7(x.1i==0){d.1l(\'c\').i(i);S.Z.o(x.b.1f);s}1a.1c=e.E(\'y\')},t,t)});2.19();$(\'.k\').n({1u:3(){2.K()}});7(2.q==1){2.K()}};2.K=3(){7(2.c==0){2.J.q=2.q;e.O(\'4/2o\',2.J,3(P){6 b=P.b;7(b.V<=0){$(\'.4-j-l\').w();$(\'.1z\').o();$(\'.k\').n(\'c\')}r{$(\'.4-j-l\').o();$(\'.1z\').w();$(\'.k\').n(\'Q\');7(b.j.f<=0||b.j.f<b.1k){$(\'.k\').n(\'c\');2.c=1}r{2.q++}}e.z(\'.4-j-l\',\'2m\',b,2.q>1);2.L()})}};2.L=3(){$(\'.k\').1y();$(\'.4-j-l .4-9\').1B(3(){6 8=$(a).5(\'8\');7($(".4-h[5-8=\'"+8+"\']").f>0){$(a).W(\':2l\').v(\'p\',t)}});$(\'.4-j-l .u-1X\').m(3(){6 $a=$(a),p=$a.v(\'p\');6 8=$a.D(\'.4-9\').5(\'8\');7(p){7($(".4-h[5-8=\'"+8+"\']").f<=0){6 9=$(a).D(\'.4-9\');6 1r=z(\'2k\',{g:{2c:8,1w:9.5(\'1w\'),1o:9.5(\'1o\'),1n:9.5(\'1n\')}});$(".4-h-l").22(1r)}}r{7($(".4-h[5-8=\'"+8+"\']").f>0){$(".4-h[5-8=\'"+8+"\']").C()}}7($(".4-h").f>0){$(\'.4-h-l\').o();2.19()}r{$(\'.4-h-l\').w()}});$(\'.23\').21(\'m\').m(3(){6 8=$(a).D(\'.u-4-9\').5(\'8\');I.20({8:8,V:1})})};2.19=3(){$(\'.4-h-l .d-1Y\').m(3(){$(a).D(\'.4-h\').C()})};2.Q=3(X){2.1m=X;7(1Z(1A.1q)!==\'24\'){I.25(1A.1q)}2.L();$(\'.u-N\').n({1u:3(){2.Y()}});$(\'.d-2a\').m(3(){$(\'#1t\').29(28).m(3(){$(\'#1t\').w()})});7(2.A==1){2.Y()}};2.Y=3(){7(2.T){s}e.O(\'y/U/26\',{q:2.A,X:2.1m},3(P){6 b=P.b;7(b.V<=0){$(\'#k\').w().$(\'.u-N\').n(\'c\')}r{$(\'#k\').o();$(\'.u-N\').n(\'Q\');7(b.j.f<=0||b.j.f<b.1k){$(\'.u-N\').n(\'c\');2.T=t}r{2.A++}}e.z(\'#k\',\'27\',b,2.A>1);2.L()})};s 2});',62,149,'||modal|function|goods|data|var|if|goodsid|item|this|result|stop|btn|core|length||selected|html|list|container|group|click|infinite|show|checked|page|else|return|true|fui|prop|hide|pjson|commission|tpl|indexPage|goodsids|remove|closest|getUrl|attr|img|logo|picker|params|getList|bindEvents|uploader|content|json|ret|init|desc|FoxUI|indexStop|myshop|total|find|mid|getIndexList|toast|openselect|isdiscount|keywords|isrecommand|ishot|isnew|istime|val|cate|bindSelectedEvents|location|by|href|on|divselect|message|order|submit|status|filename|pagesize|removeAttr|indexMid|thumb|marketprice|li|cartcount|itemHTML|util|cover|onLoading|icon|title|first|lazyload|empty|window|each|child|false|initSet|removeUrl|menu|uploadUrl|roundclose|define|change|imageLogo|biz|issendfree|name|shopname|defaults|imageImg|nav|shopdata|set|removeIcon|initSelect|switch|delete|typeof|open|unbind|prepend|buy|undefined|changeCartcount|get_goods|tpl_commission_myshop_goods_list|200|fadeIn|favorite|siblings|id|push|selectgoods|nocommission|addClass|removeClass|opencategory|selectcategory|tpl_commission_goods_item|checkbox|tpl_commission_goods_select|select|query'.split('|'),0,{}))

define(['core', 'tpl', 'biz/goods/picker'], function (core, tpl, picker) {
    var defaults = {
        keywords: '',
        isrecommand: '',
        ishot: '',
        isnew: '',
        isdiscount: '',
        issendfree: '',
        istime: '',
        cate: '',
        order: '',
        by: 'desc'
    };
    var modal = {
        page: 1,
        params: {},
        stop: 0,
        indexPage: 1,
        indexStop: false,
        options: [],
        optionIndex: 0,
        goodDetail: {}
    };
    modal.initSet = function () {
        $('.fui-uploader').uploader({
            uploadUrl: core.getUrl('util/uploader'),
            remove: true,
            removeIcon: 'icon icon-roundclose',
            removeUrl: core.getUrl('util/uploader/remove')
        });
        $('.btn-submit').click(function () {
            var btn = $(this);
            if (btn.attr('stop')) {
                return
            }
            var html = btn.html();
            var logo = $('#imageLogo').find('li:first-child');
            var img = $('#imageImg').find('li:first-child');
            var data = {
                name: $('#shopname').val(),
                desc: $('#desc').val(),
                logo: logo.length > 0 ? logo.data('filename') : '',
                img: img.length > 0 ? img.data('filename') : ''
            };
            btn.attr('stop', 1).html('正在处理...');
            core.json('commission/myshop/set', {
                shopdata: data
            }, function (pjson) {
                if (pjson.status == 0) {
                    btn.removeAttr('stop').html(html);
                    FoxUI.toast.show(pjson.result.message);
                    return
                }
                location.href = core.getUrl('commission')
            }, true, true)
        })
    };
    modal.initSelect = function () {
        $('#openselect').change(function () {
            var $this = $(this);
            if ($this.prop('checked')) {
                $('#divselect').show()
            } else {
                $('#divselect').hide()
            }
        });
        $('.container').lazyload();
        $('.menu nav').click(function () {
            $('.se-cate-all').css('color', '#666');
            $('.container').infinite('init');
            var item = $(this);
            item.siblings().removeClass("on");
            item.addClass("on");
            // ietm.css('background','#f2f2f2');
            // item.siblings().css("background", "none");
            console.log(item.data('cate'))
            $('.goods-list-group').html('');
            modal.params = {
                isnew: item.data('isnew') || '',
                ishot: item.data('ishot') || '',
                isrecommand: item.data('isrecommand') || '',
                isdiscount: item.data('isdiscount') || '',
                keywords: $('#keywords').val(),
                istime: item.data('istime') || '',
                cate: item.data('cate') || '',
                nocommission: 0,
                order: "",
                by: ""
            };
            modal.page = 1,
            modal.stop = 0;
            modal.getList()
        });

        $('.se-cate-all').click(function () {
            $(this).css('color', '#ED322B');
            $('.menu nav').removeClass("on");

            $('.goods-list-group').html('');
            modal.params = {
                isnew: '',
                ishot: '',
                isrecommand: '',
                isdiscount: '',
                keywords: '',
                istime: '',
                cate: 0,
                nocommission: 0,
                order: "",
                by: ""
            };
            modal.page = 1,
            modal.stop = 0;
            modal.getList()
        });

        $('.btn-submit').click(function () {
            var btn = $(this);
            if (btn.attr('stop')) {
                return
            }
            var html = btn.html();
            var goodsids = [];
            $(".goods-selected").each(function () {
                goodsids.push($(this).data('goodsid'))
            });
            if (goodsids.length <= 0 && $('#openselect').prop('checked')) {
                FoxUI.toast.show('请选择商品!');
                return
            }
            var data = {
                selectgoods: $('#openselect').prop('checked') ? 1 : 0,
                selectcategory: $('#opencategory').prop('checked') ? 1 : 0,
                goodsids: goodsids
            };
            btn.attr('stop', 1).html('正在处理...');
            core.json('commission/myshop/select', data, function (pjson) {
                if (pjson.status == 0) {
                    btn.removeAttr('stop').html(html);
                    FoxUI.toast.show(pjson.result.message);
                    return
                }
                location.href = core.getUrl('commission')
            }, true, true)
        });
        modal.bindSelectedEvents();
        $('.container').infinite({
            onLoading: function () {
                modal.getList()
            }
        });
        if (modal.page == 1) {
            modal.getList()
        }
    };
    modal.getList = function () {
        if (modal.stop == 0) {
            modal.params.page = modal.page;
            core.json('goods/query', modal.params, function (ret) {
                var result = ret.result;
                if (result.total <= 0) {
                    $('.goods-list-group').hide();
                    $('.empty').show();
                    $('.container').infinite('stop')
                } else {
                    $('.goods-list-group').show();
                    $('.empty').hide();
                    $('.container').infinite('init');
                    if (result.list.length <= 0 || result.list.length < result.pagesize) {
                        $('.container').infinite('stop');
                        modal.stop = 1
                    } else {
                        modal.page++
                    }
                }
                // console.log(result)
                // result.list = result.list.concat(result.list);
                // result.list = result.list.concat(result.list);
                // result.list = result.list.concat(result.list);
                // result.list = result.list.concat(result.list);
                core.tpl('.goods-list-group', 'tpl_commission_goods_select', result, modal.page > 1);
                modal.bindEvents()
            })
        }
    };
    modal.bindEvents = function () {
        $('.container').lazyload();
        $('.goods-list-group .goods-item').each(function () {
            var goodsid = $(this).data('goodsid');
            if ($(".goods-selected[data-goodsid='" + goodsid + "']").length > 0) {
                $(this).find(':checkbox').prop('checked', true)
            }
        });
        $('.goods-list-group .fui-switch').click(function () {
            var $this = $(this),
                checked = $this.prop('checked');
            var goodsid = $this.closest('.goods-item').data('goodsid');
            if (checked) {
                    if ($(".goods-selected[data-goodsid='" + goodsid + "']").length <= 0) {
                        var item = $(this).closest('.goods-item');
                        var itemHTML = tpl('tpl_commission_goods_item', {
                            g: {
                                id: goodsid,
                                title: item.data('title'),
                                marketprice: item.data('marketprice'),
                                thumb: item.data('thumb')
                            }
                        });
                        $(".goods-selected-group").prepend(itemHTML)
                    }
                } else {
                    if ($(".goods-selected[data-goodsid='" + goodsid + "']").length > 0) {
                        $(".goods-selected[data-goodsid='" + goodsid + "']").remove()
                    }
                }
            if ($(".goods-selected").length > 0) {
                    $('.goods-selected-group').show();
                    modal.bindSelectedEvents()
                } else {
                    $('.goods-selected-group').hide()
                }
        });
        $('.buy').unbind('click').click(function () {
            var goodsid = $(this).closest('.fui-goods-item').data('goodsid');
            picker.open({
                goodsid: goodsid,
                total: 1
            })
        });
        $('.commission-detail').click(function (e) {
        	console.log($(this).attr('data-id'));
        	var data = {
        		goodid: $(this).attr('data-id')
        	};

        	core.json('commission/myshop/select/good', data, function (pjson) {
        	    var data = pjson.result;

	        	// FoxUI.confirm('确认要支付吗?', '提醒', function () {
	                
	         //    }, function () {
	                
	         //    })
	         	var showData = {};
	         	showData.commission1 = data.good.marketprice * data.set.commission1 / 100;
	         	showData.commission2 = data.good.marketprice * data.set.commission2 / 100;
	         	showData.price = data.good.marketprice;
	         	console.log(showData)

	         	core.tpl('#myshop-select-goods', 'tpl_commission_goods_detail', showData, true);
        	}, true, true)
        });

        $('#myshop-select-goods').on('click', '.se-btn', function() {
        	console.log('close');
        	$('.se-confirm').remove();
        });

        // 参数改变
        function changeParams() {
            console.log(modal);
            if (modal.hasOptions) {
                var option = modal.options[modal.optionIndex];
                var commission = modal.commission;
                var goodDetail = modal.goodDetail;
                $('.se-marketprice').html((option.marketprice));
                $('.se-vstock').html(parseInt(option.vstock));
                $('.se-provinceprice').html((option.provinceprice));
                $('.se-cityprice').html((option.cityprice));
                $('.se-countyprice').html((option.countyprice));
                // $('.se-commission1').html(parseInt((option.productprice-option.costprice)*commission.commission1/100) + parseInt(option.countyprice));
                // $('.se-commission2').html(parseInt((option.productprice-option.costprice)*(parseInt(commission.commission2) + parseInt(commission.commission1))/100) + parseInt(option.countyprice));
                // $('.se-commission3').html(parseInt((option.productprice-option.costprice)*(parseInt(commission.commission3) + parseInt(commission.commission2) + parseInt(commission.commission1))/100) + parseInt(option.countyprice));
                $('.se-commission1').html(((option.productprice-option.costprice)*commission.commission1/100).toFixed(2));
                $('.se-commission2').html(((option.productprice-option.costprice)*commission.commission2/100).toFixed(2));
                $('.se-commission3').html(((option.productprice-option.costprice)*commission.commission3/100).toFixed(2));

                $('.se-title').html(goodDetail.title);
                $('.se-goods-thumb').attr('src', '../attachment/'+goodDetail.thumb);
                $('.se-join-stock').val(parseInt(option.vstock));
            } else {
                var goodDetail = modal.goodDetail;
                var commission = modal.commission;
                $('.se-marketprice').html((goodDetail.marketprice));
                $('.se-vstock').html(parseInt(goodDetail.vstock));
                $('.se-provinceprice').html((goodDetail.provinceprice));
                $('.se-cityprice').html((goodDetail.cityprice));
                $('.se-countyprice').html((goodDetail.countyprice));
                // $('.se-commission1').html(parseInt((goodDetail.productprice-goodDetail.costprice)*commission.commission1/100) + parseInt(goodDetail.countyprice));
                // $('.se-commission2').html(parseInt((goodDetail.productprice-goodDetail.costprice)*(parseInt(commission.commission2) + parseInt(commission.commission1))/100) + parseInt(goodDetail.countyprice));
                // $('.se-commission3').html(parseInt((goodDetail.productprice-goodDetail.costprice)*(parseInt(commission.commission3) + parseInt(commission.commission1) + parseInt(commission.commission2))/100) + parseInt(goodDetail.countyprice));
                $('.se-commission1').html(((goodDetail.marketprice-goodDetail.costprice)*commission.commission1/100).toFixed(2)); 
                $('.se-commission2').html(((goodDetail.marketprice-goodDetail.costprice)*commission.commission2/100).toFixed(2));
                $('.se-commission3').html(((goodDetail.marketprice-goodDetail.costprice)*commission.commission3/100).toFixed(2));
                $('.se-confirm').attr('data-goodsid', goodDetail.id);
                $('.se-title').html(goodDetail.title);
                $('.se-goods-thumb').attr('src', '../attachment/'+goodDetail.thumb);
                $('.se-join-stock').val(parseInt(goodDetail.vstock));
            }
        }

        // 点击查看详情
        $('.se-modal-btn').unbind('click').click(function() {
            var title = $(this).attr('data-title');
            var thumb = $(this).attr('data-thumb');
            var goodsid = $(this).attr('data-goodsid');


            core.json('commission/myshop/select/getDetail', {
               goodsid: goodsid
            }, function (res) {
                console.info(res);
                var html = '';
                modal.options = res.result.options || [];
                modal.commission = res.result.commission;
                modal.hasOptions = res.result.hasOptions;
                modal.goodDetail = res.result.goodDetail;

                if (modal.hasOptions) {
                    $('.se-options-wrap').show();
                    for (var i = 0; i < modal.options.length; i++) {
                        html += '<div class="se-select';
                        if (i === 0) html += ' active';
                        html += '" style="width: 4.6rem; text-align: center; color: #959595; height: 1.4rem; line-height: 1.4rem; border: .2rem; border: 1px solid #e9e9e9; margin-bottom: .4rem; margin-right: .6rem">' + modal.options[i].title + '</div>';                    
                    }
                    $('.se-options-box').html(html);

                    // 点击切换参数
                    $('.se-select').click(function() {
                        $(this).siblings().removeClass('active');
                        $(this).addClass('active');
                        modal.optionIndex = $(this).index();
                        changeParams();
                    });
                } else {
                    $('.se-options-wrap').hide();
                }

                changeParams();
                $('.se-modal').show();
            });
        });

        // 点击修改库存
        $('.se-confirm').unbind('click').click(function() {
            console.log('confirm', modal);
            var goodsid = $(this).attr('data-goodsid');   
            var joinStock = $('.se-join-stock').val();
            var stockOptionId = modal.options.length > 0 ? modal.options[modal.optionIndex].id : 0;
            var realStock = 0;
            // 检查是否超出限制
            if (modal.hasOptions) {
                realStock = modal.options[modal.optionIndex].stock;
            } else {
                realStock = modal.goodDetail.stock;
            }
            if (+joinStock > +realStock) {
                FoxUI.alert('请设置少于' + realStock + '件商品');
                return;
            }


            if (joinStock) {
                if (modal.hasOptions) {
                    core.json('commission/myshop/select/setStock', {
                        stockOptionId: stockOptionId,
                        joinStock: joinStock,
                        hasOptions: true,
                        goodsid: modal.goodDetail.id
                    }, function (res) {
                        console.log(res);
                        modal.optionIndex = 0;
                        $('.se-join-stock').val('');
                        $('.se-modal').hide();
                    })
                } else {
                    core.json('commission/myshop/select/setStock', {
                        goodsid: goodsid,
                        joinStock: joinStock,
                        hasOptions: false
                    }, function (res) {
                        console.log(res);
                        modal.optionIndex = 0;
                        $('.se-join-stock').val('');
                        $('.se-modal').hide();
                    })
                }

            } else {
                alert('请设置库存件数');
            }

        });
        // 点击取消
        $('.se-cancel').unbind('click').click(function() {
            modal.optionIndex = 0;
            $('.se-join-stock').val('');
            $('.se-modal').hide();
        });
    };

    modal.bindSelectedEvents = function () {
        $('.goods-selected-group .btn-delete').click(function () {
            $(this).closest('.goods-selected').remove()
        })
    };
    modal.init = function (mid) {
        modal.indexMid = mid;
        if (typeof(window.cartcount) !== 'undefined') {
            picker.changeCartcount(window.cartcount)
        }
        modal.bindEvents();
        $('.fui-content').infinite({
            onLoading: function () {
                modal.getIndexList()
            }
        });
        $('.btn-favorite').click(function () {
            $('#cover').fadeIn(200).click(function () {
                $('#cover').hide()
            })
        });
        if (modal.indexPage == 1) {
            modal.getIndexList()
        }
    };
    modal.getIndexList = function () {
        if (modal.indexStop) {
            return
        }

        core.json('commission/myshop/get_goods', {
            page: modal.indexPage,
            mid: modal.indexMid
        }, function (ret) {
            var result = ret.result;
            if (result.total <= 0) {
                $('#container').hide().$('.fui-content').infinite('stop')
            } else {
                $('#container').show();
                $('.fui-content').infinite('init');
                if (result.list.length <= 0 || result.list.length < result.pagesize) {
                    $('.fui-content').infinite('stop');
                    modal.indexStop = true
                } else {
                    modal.indexPage++
                }
            }
            core.tpl('#container', 'tpl_commission_myshop_goods_list', result, modal.indexPage > 1);
            modal.bindEvents()
        })
    };
    return modal
});