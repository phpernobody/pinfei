// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('2f([\'t\',\'1j\',\'1C/1I/1c\',\'1C/2e/u\'],9(t,1j,1c,u){d 5={x:0,a:[],n:g,m:[],B:[],8:{w:\'\',1w:\'\',19:\';\',n:g,h:1,i:0,1n:g,1g:g,1d:M}};5.2d=9(8){5.8=$.2a(5.8,8||{});7(5.x!=8.x){5.x=8.x;t.1G(\'a/y\',{k:8.x},9(f){7(f.12==0){l.C.e(\'未找到商品!\');b}2b.2c(f.z.a);5.Y=\'\';5.K=\'\';7(f.12==2){5.Y=f.z.Y;5.K=f.z.K;5.e();b}7(f.12==4){5.1H=1;5.e();b}7(f.12==3){5.1M=1;5.e();b}5.1B=1j(\'n-y\',f.z);5.a=f.z.a;5.m=f.z.m;5.B=f.z.B;5.V=f.z.V;7(5.a.T==\'\'){5.a.T=\'件\'}5.e()},M,g)}r{5.e()}};5.E=9(){5.6.E()};5.1E=9(){$(\'.2i\',5.6.6).U(\'p\').p(9(){5.E()});$(\'.17-1o\').U(\'p\').p(9(){5.E()});7(5.V==g){$(\'.17-2n\',5.6.6).2o({2m:5.8.h,18:5.a.1f,1F:5.a.1a,2l:"{1F}"+5.a.T+"起售",2k:"最多购买{18}"+5.a.T,1y:9(j){5.8.h=j}})}r{5.8.h=1}$(".v-q",5.6.6).U(\'p\').p(9(){5.1p(c)});$(\'.13\',5.6.6).U(\'p\').p(9(){5.1i()});$(\'.X\',5.6.6).U(\'p\').p(9(){7($(c).1v(\'W\')){b}7(!5.1e()){b}7($(\'.u-6\').o>0){d D=u.1K(\'.u-6\');7(!D){b}r{t.1G(\'14/15/u\',{k:5.a.k,D:D},9(f){G.H=t.N(\'14/15\',{k:5.a.k,i:5.8.i,h:5.8.h,25:f.z.20})},M,M)}}r{G.H=t.N(\'14/15\',{k:5.a.k,i:5.8.i,h:5.8.h})}7(5.8.1d){5.E()}});$(\'.10\',5.6.6).U(\'p\').p(9(){7($(c).1v(\'W\')){b}7(!5.1e()){b}7(5.8.1g){5.8.h=1h($(\'.j\',5.6.6).1b());5.8.1g(5.8.h,5.8.i,5.8.w,5.8.1w)}7(5.8.1d){5.E()}});d O=$(26.24).O();5.6.6.R(\'.n-y\').1N(\'18-O\',O-28);5.6.6.R(\'.n-y .n-y-B\').1N(\'18-O\',O-2D)};5.1i=9(){7(!5.a.1X){l.C.e(\'此商品不可加入购物车<2J>请直接点击立刻购买\');b}7($(c).1v(\'W\')){b}7(!5.1e()){b}5.8.h=1h($(\'.j\',5.6.6).1b());7($(\'.u-6\').o>0){l.1L.e(\'2q\');d D=u.1K(\'.n-y .u-6\');l.1L.Q();7(!D){b}1c.1A(5.x,5.8.i,5.8.h,D,9(f){l.C.e(\'添加成功\');5.1m(f.1D)})}r{1c.1A(5.x,5.8.i,5.8.h,g,9(f){l.C.e(\'添加成功\');5.1m(f.1D)})}7(5.8.1d){5.E()}};5.e=9(){7(5.Y){l.1J(5.Y,9(){7(5.K!=\'\'&&5.K!=2O){G.H=5.K}});b}7(5.1H){d P=t.N(\'a/2L\',{k:5.x});P=P.2E("./2v.2u?","");l.1J("请先登录","提示",9(){G.H=t.N(\'2t/2r\',{P:1z(P)})});b}7(5.1M){l.2s("请先绑定手机","提示",9(){G.H=t.N(\'1I/2w\',{P:1z(G.H)})});b}5.6=1S 2C({2B:5.1B,2y:"y-5"});5.1E();7(5.V&&5.V.12==0){$(\'.17-1o\').Q(),$(\'.y-5\').Q();7((2G(5.B.o)===\'2z\'||5.B.o<=0)&&$(\'.u-6\').o<=0){7(5.8.2A==\'2x\'){G.H=t.N(\'14/15\',{k:5.a.k,h:1,i:0});b}r{5.1i();b}}}$(\'.17-1o\').e(),$(\'.y-5\').e();7(5.8.1U){$(\'.10\',5.6.6).e()}r{$(\'.X\',5.6.6).e();7(5.a.1X){$(\'.13\',5.6.6).e()}}7(5.8.i!=\'0\'){5.1W()}5.6.e()};5.1W=9(){$(".v-q").1t(\'L-S\');d i=5.8.i;d m=g;$.F(5.B,9(){7(c.k==i){m=c.m.19(\'16\');b g}});7(m){d q=g;d Z=[];$(".v-q").F(9(){d q=$(c),1Q=q.1x(\'k\');$.F(m,9(){7(c==1Q){Z.1r(q);q.1s(\'L-S\')}})});7(Z.o>0){d 1O=Z[Z.o-1];5.1p(1O,g)}}};5.1p=9(1R,1y){d $c=$(1R);$c.2F(\'.v\').R(\'.v-q\').1t(\'L-S\'),$c.1s(\'L-S\');d J=$c.1x(\'J\')||\'\';7(J){$(\'.J\',5.6.6).2M(\'2N\',J)}5.8.1w=J;d I=$(".v-q.L-S",5.6.6);d 1q=[];7(I.o==5.m.o){I.F(9(){1q.1r($(c).1x(\'k\'))});$.F(5.B,9(){d m=c.m.19(\'16\').1T().1u(\'16\');7(m==1q.1T().1u(\'16\')){d s=c.s==\'-1\'?\'无限\':c.s;$(\'.h\',5.6.6).A(s);7(c.s!=\'-1\'&&c.s<=0){$(\'.10\',5.6).e().1s(\'W\').A(\'库存不足\');$(\'.13,.X\',5.6).Q()}r{7(5.8.1U){$(\'.10\',5.6).1t(\'W\').A(\'确定\');$(\'.13,.X\',5.6).Q()}r{$(\'.13,.X\',5.6).e(),$(\'.10\').Q()}}d 1Z=1P.2K(1S 1P())/2P;7(5.a.2I>0&&(5.a.1V==0||5.a.1V>1Z)){$(\'.1Y\',5.6.6).A(c.2H)}r{$(\'.1Y\',5.6.6).A(c.2j)}5.n=c;5.8.i=c.k}})}d w=[];I.F(9(){w.1r($.23($(c).A()))});5.8.w=w.1u(5.8.19);$(\'.22-w\',5.6.6).A(\'已选 \'+5.8.w);7(1y){7(5.8.1n){5.8.1n(5.8.h,5.8.i,5.8.w)}}};5.1e=9(){d v=$(".v",5.6.6);d I=M;v.F(9(){7($(c).R(\'.v-q.L-S\').o<=0){l.C.e(\'请选择\'+$(c).R(\'.27\').A());I=g;b g}});7(I){7(5.n.s!=-1&&5.n.s<=0){l.C.e(\'库存不足\');b g}d j=1h($(\'.j\',5.6.6).1b());7(j<=0){j=1}7(j>5.n.s){j=5.n.s}$(".j",5.6.6).1b(j);7(5.a.1f>0&&j>5.a.1f){l.C.e(\'最多购买 \'+5.a.1f+\' \'+5.a.T);b g}7(5.a.1a>0&&j<5.a.1a){l.C.e(5.a.1a+5.a.T+\'起售\');b g}b M}b g};5.1m=9(1k){7($("#1l").o>0){d 11=$("#1l").R(".11");7(11.o<1){$("#1l").21(\'<2p 29="11">\'+1k+\'</2h>\')}r{11.2g(1k)}}};b 5});',62,176,'|||||modal|container|if|params|function|goods|return|this|var|show|ret|false|total|optionid|num|id|FoxUI|specs|option|length|click|item|else|stock|core|diyform|spec|titles|goodsid|picker|result|html|options|toast|diyformdata|close|each|location|href|selected|thumb|followurl|btn|true|getUrl|height|backurl|hide|find|danger|unit|unbind|seckillinfo|disabled|buybtn|followtip|selectitems|confirmbtn|badge|status|cartbtn|order|create|_|fui|max|split|minbuy|val|cart|autoClose|check|maxbuy|onConfirm|parseInt|addToCart|tpl|count|menucart|changeCartcount|onSelected|mask|chooseSpec|itemids|push|addClass|removeClass|join|hasClass|optionthumb|data|callback|btoa|add|containerHTML|biz|cartcount|init|min|json|needlogin|member|confirm|getData|loader|mustbind|css|lastitem|Date|itemid|obj|new|sort|showConfirm|preselltimeend|initOption|canAddCart|price|timestamp|goods_data_id|append|info|trim|body|gdid|document|title|50|class|extend|console|log|open|plugin|define|text|div|closebtn|marketprice|maxToast|minToast|value|number|numbers|span|mini|login|alert|account|php|index|bind|buy|extraClass|undefined|action|content|FoxUIModal|225|replace|closest|typeof|presellprice|ispresell|br|parse|detail|attr|src|null|1000'.split('|'),0,{}))


define(['core', 'tpl', 'biz/member/cart', 'biz/plugin/diyform'], function (core, tpl, cart, diyform) {
    var modal = {
        goodsid: 0,
        goods: [],
        option: false,
        specs: [],
        options: [],
        params: {
            titles: '',
            optionthumb: '',
            split: ';',
            option: false,
            total: 1,
            optionid: 0,
            onSelected: false,
            onConfirm: false,
            autoClose: true
        }
    };
    modal.open = function (params) {
        modal.params = $.extend(modal.params, params || {});
        if (modal.goodsid != params.goodsid) {
            modal.goodsid = params.goodsid;
            core.json('goods/picker', {
                id: params.goodsid
            }, function (ret) {
                if (ret.status == 0) {
                    FoxUI.toast.show('未找到商品!');
                    return
                }
                modal.followtip = '';
                modal.followurl = '';
                if (ret.status == 2) {
                    modal.followtip = ret.result.followtip;
                    modal.followurl = ret.result.followurl;
                    modal.show();
                    return
                }
                if (ret.status == 4) {
                    modal.needlogin = 1;
                    modal.show();
                    return
                }
                if (ret.status == 3) {
                    modal.mustbind = 1;
                    modal.show();
                    return
                }
                // 有代理商价格
                var agentInfo = ret.result.agentInfo;

                if(agentInfo.isagent) {
                    ret.result.goods.maxprice = agentInfo.maxprice;
                    ret.result.goods.minprice = agentInfo.minprice;
                }

                modal.containerHTML = tpl('option-picker', ret.result);
                console.log(ret.result);
                // debugger;
                modal.goods = ret.result.goods;
                modal.specs = ret.result.specs;
                modal.options = ret.result.options;
                modal.seckillinfo = ret.result.seckillinfo;
                if (modal.goods.unit == '') {
                    modal.goods.unit = '件'
                }
                modal.show()
            }, true, false)
        } else {
            modal.show()
        }
    };
    modal.close = function () {
        modal.container.close()
    };
    modal.init = function () {
        $('.closebtn', modal.container.container).unbind('click').click(function () {
            modal.close()
        });
        $('.fui-mask').unbind('click').click(function () {
            modal.close()
        });
        if (modal.seckillinfo == false) {
            $('.fui-number', modal.container.container).numbers({
                value: modal.params.total,
                max: modal.goods.maxbuy,
                min: modal.goods.minbuy,
                minToast: "{min}" + modal.goods.unit + "起售",
                maxToast: "最多购买{max}" + modal.goods.unit,
                callback: function (num) {
                    modal.params.total = num
                }
            })
        } else {
            modal.params.total = 1
        }
        $(".spec-item", modal.container.container).unbind('click').click(function () {
            modal.chooseSpec(this)
        });
        $('.cartbtn', modal.container.container).unbind('click').click(function () {
            modal.addToCart()
        });
        $('.buybtn', modal.container.container).unbind('click').click(function () {
            if ($(this).hasClass('disabled')) {
                return
            }
            if (!modal.check()) {
                return
            }
            if ($('.diyform-container').length > 0) {
                var diyformdata = diyform.getData('.diyform-container');
                if (!diyformdata) {
                    return
                } else {
                    core.json('order/create/diyform', {
                        id: modal.goods.id,
                        diyformdata: diyformdata
                    }, function (ret) {
                        location.href = core.getUrl('order/create', {
                            id: modal.goods.id,
                            optionid: modal.params.optionid,
                            total: modal.params.total,
                            gdid: ret.result.goods_data_id
                        })
                    }, true, true)
                }
            } else {
                location.href = core.getUrl('order/create', {
                    id: modal.goods.id,
                    optionid: modal.params.optionid,
                    total: modal.params.total
                })
            }
            if (modal.params.autoClose) {
                modal.close()
            }
        });
        $('.confirmbtn', modal.container.container).unbind('click').click(function () {
            if ($(this).hasClass('disabled')) {
                return
            }
            if (!modal.check()) {
                return
            }
            if (modal.params.onConfirm) {
                modal.params.total = parseInt($('.num', modal.container.container).val());
                modal.params.onConfirm(modal.params.total, modal.params.optionid, modal.params.titles, modal.params.optionthumb)
            }
            if (modal.params.autoClose) {
                modal.close()
            }
        });
        var height = $(document.body).height();
        modal.container.container.find('.option-picker').css('max-height', height - 50);
        modal.container.container.find('.option-picker .option-picker-options').css('max-height', height - 225)
    };
    modal.addToCart = function () {
        console.log('addToCart')
        if (!modal.goods.canAddCart) {
            FoxUI.toast.show('此商品不可加入购物车<br>请直接点击立刻购买');
            return
        }
        if ($(this).hasClass('disabled')) {
            return
        }
        if (!modal.check()) {
            return
        }
        modal.params.total = parseInt($('.num', modal.container.container).val());
        if ($('.diyform-container').length > 0) {
            FoxUI.loader.show('mini');
            var diyformdata = diyform.getData('.option-picker .diyform-container');
            FoxUI.loader.hide();
            if (!diyformdata) {
                return
            }
            cart.add(modal.goodsid, modal.params.optionid, modal.params.total, diyformdata, function (ret) {
                FoxUI.toast.show('添加成功');
                modal.changeCartcount(ret.cartcount)
            })
        } else {
            cart.add(modal.goodsid, modal.params.optionid, modal.params.total, false, function (ret) {
                FoxUI.toast.show('添加成功');
                modal.changeCartcount(ret.cartcount)
            })
        }
        if (modal.params.autoClose) {
            modal.close()
        }
    };
    modal.show = function () {
        if (modal.followtip) {
            FoxUI.confirm(modal.followtip, function () {
                if (modal.followurl != '' && modal.followurl != null) {
                    location.href = modal.followurl
                }
            });
            return
        }
        if (modal.needlogin) {
            var backurl = core.getUrl('goods/detail', {
                id: modal.goodsid
            });
            backurl = backurl.replace("./index.php?", "");
            FoxUI.confirm("请先登录", "提示", function () {
                location.href = core.getUrl('account/login', {
                    backurl: btoa(backurl)
                })
            });
            return
        }
        if (modal.mustbind) {
            FoxUI.alert("请先绑定手机", "提示", function () {
                location.href = core.getUrl('member/bind', {
                    backurl: btoa(location.href)
                })
            });
            return
        }
        modal.container = new FoxUIModal({
            content: modal.containerHTML,
            extraClass: "picker-modal"
        });
        modal.init();
        if (modal.seckillinfo && modal.seckillinfo.status == 0) {
            $('.fui-mask').hide(),
            $('.picker-modal').hide();
            if ((typeof(modal.options.length) === 'undefined' || modal.options.length <= 0) && $('.diyform-container').length <= 0) {
                if (modal.params.action == 'buy') {
                    location.href = core.getUrl('order/create', {
                        id: modal.goods.id,
                        total: 1,
                        optionid: 0
                    });
                    return
                } else {
                    modal.addToCart();
                    return
                }
            }
        }
        $('.fui-mask').show(),
        $('.picker-modal').show();
        if (modal.params.showConfirm) {
            $('.confirmbtn', modal.container.container).show()
        } else {
            $('.buybtn', modal.container.container).show();
            if (modal.goods.canAddCart) {
                $('.cartbtn', modal.container.container).show()
            }
        }
        if (modal.params.optionid != '0') {
            modal.initOption()
        }
        modal.container.show()
    };
    modal.initOption = function () {
        $(".spec-item").removeClass('btn-danger');
        var optionid = modal.params.optionid;
        var specs = false;
        $.each(modal.options, function () {
            if (this.id == optionid) {
                specs = this.specs.split('_');
                return false
            }
        });
        if (specs) {
            var item = false;
            var selectitems = [];
            $(".spec-item").each(function () {
                var item = $(this),
                    itemid = item.data('id');
                $.each(specs, function () {
                        if (this == itemid) {
                            selectitems.push(item);
                            item.addClass('btn-danger')
                        }
                    })
            });
            if (selectitems.length > 0) {
                var lastitem = selectitems[selectitems.length - 1];
                modal.chooseSpec(lastitem, false)
            }
        }
    };
    modal.chooseSpec = function (obj, callback) {
        var $this = $(obj);
        $this.closest('.spec').find('.spec-item').removeClass('btn-danger'),
        $this.addClass('btn-danger');
        var thumb = $this.data('thumb') || '';
        if (thumb) {
            $('.thumb', modal.container.container).attr('src', thumb)
        }
        modal.params.optionthumb = thumb;
        var selected = $(".spec-item.btn-danger", modal.container.container);
        var itemids = [];
        if (selected.length == modal.specs.length) {
            selected.each(function () {
                itemids.push($(this).data('id'))
            });
            $.each(modal.options, function () {
                var specs = this.specs.split('_').sort().join('_');
                console.log('dd', specs, itemids);
                if (specs == itemids.sort().join('_')) {
                    var stock = this.stock == '-1' ? '无限' : this.stock;
                    $('.total', modal.container.container).html(stock);
                    if (this.stock != '-1' && this.stock <= 0) {
                        $('.confirmbtn', modal.container).show().addClass('disabled').html('库存不足');
                        $('.cartbtn,.buybtn', modal.container).hide()
                    } else {
                        if (modal.params.showConfirm) {
                            $('.confirmbtn', modal.container).removeClass('disabled').html('确定');
                            $('.cartbtn,.buybtn', modal.container).hide()
                        } else {
                            $('.cartbtn,.buybtn', modal.container).show(),
                            $('.confirmbtn').hide()
                        }
                    }
                    var timestamp = Date.parse(new Date()) / 1000;
                    if (modal.goods.ispresell > 0 && (modal.goods.preselltimeend == 0 || modal.goods.preselltimeend > timestamp)) {
                        $('.price', modal.container.container).html(this.presellprice)
                    } else {
                        $('.price', modal.container.container).html(this.marketprice)
                    }
                    modal.option = this;
                    modal.params.optionid = this.id
                }
            })
        }
        var titles = [];
        selected.each(function () {
            titles.push($.trim($(this).html()))
        });
        modal.params.titles = titles.join(modal.params.split);
        $('.info-titles', modal.container.container).html('已选 ' + modal.params.titles);
        if (callback) {
            if (modal.params.onSelected) {
                modal.params.onSelected(modal.params.total, modal.params.optionid, modal.params.titles)
            }
        }
    };
    modal.check = function () {
        var spec = $(".spec", modal.container.container);
        var selected = true;
        spec.each(function () {
            if ($(this).find('.spec-item.btn-danger').length <= 0) {
                FoxUI.toast.show('请选择' + $(this).find('.title').html());
                selected = false;
                return false
            }
        });
        if (selected) {
            if (modal.option.stock != -1 && modal.option.stock <= 0) {
                FoxUI.toast.show('库存不足');
                return false
            }
            var num = parseInt($('.num', modal.container.container).val());
            if (num <= 0) {
                num = 1
            }
            if (num > modal.option.stock) {
                num = modal.option.stock
            }
            $(".num", modal.container.container).val(num);
            if (modal.goods.maxbuy > 0 && num > modal.goods.maxbuy) {
                FoxUI.toast.show('最多购买 ' + modal.goods.maxbuy + ' ' + modal.goods.unit);
                return false
            }
            if (modal.goods.minbuy > 0 && num < modal.goods.minbuy) {
                FoxUI.toast.show(modal.goods.minbuy + modal.goods.unit + '起售');
                return false
            }
            return true
        }
        return false
    };
    modal.changeCartcount = function (count) {
        if ($("#menucart").length > 0) {
            var badge = $("#menucart").find(".badge");
            if (badge.length < 1) {
                $("#menucart").append('<span class="badge">' + count + '</div>')
            } else {
                badge.text(count)
            }
        }
    };
    return modal
});