// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('3C([\'f\',\'1K\',\'1u/13/9\',\'1u/2B/1t\',\'1u/2B/R\',\'1u/3D/E\'],3(f,1K,9,1t,R,E){b 2={};2.1W=3(14){2.2C=14.2C;2.o=14.o;2.w=0;2.n=1;2.1Y=14.1Y;2.1b=14.1b;2.1s=14.1s;15.B({4:$(\'#B\'),3A:{3x:3(){$(\'.Q-8\').m();2.1R();2.1C();2.1d()},3y:3(){2.1C();2.1d();2.1O()},3z:3(){2.2U();2.1d()},3E:3(){2.2J()}}});2.1R();2.1C();2.1d();$(\'.1U-36\').a(3(){2.1D(\'\')});$(\'#P-a\').1x("a",3(){$("#P-9").m()});$(\'.P-p\').1x("a",3(){$("#P-9").N()});$(\'#P-3F\').1x("a",3(){$("#P-9").N()});$(\'#2E-9\').a(3(){2.A=1f 1G({r:$(\'#2E-9-2\').6(),1w:\'9-2\',1F:3(){2.A.p()}});2.A.4.e(\'.1j-11\').a(3(){2.A.p()});2.A.m()});$(\'#2A-9\').a(3(){2.A=1f 1G({r:$(\'#2A-9-2\').6(),1w:\'9-2\',1F:3(){2.A.p()}});15.3K.1W();2.A.4.e(\'.1j-11\').a(3(){2.A.p()});2.A.m()});$(".2v-2w .3G").a(3(){2.1D(\'R\')});$(".2v-2w .3N").a(3(){2.1D(\'32\')});5($(\'#17-4\').v>0||$(\'#2x-4\').v>0){$(\'.k-2y\').1o({2F:3(){1n.1k()},2G:3(){1n.1k()}})}t 5($(\'#17-3s\').v>0||$(\'#2x-4\').v>0){$(\'.k-2y\').1o({2F:3(){1n.1k()},2G:3(){1n.1k()}})}t 5($(\'.28-4\').v>0){2.2S()}$(\'.1t-12\').a(3(){b M=$(u);5(M.z(\'20\')==\'1\'){L}M.z(\'20\',1);b G=M.z(\'c-G\')==\'1\';b 7=M.e(\'.7\');7.s(\'7-2N\').s(\'7-2O\');G&&7.y(\'7-2N\');!G&&7.y(\'7-2O\');M.3f(\'W\');5(!G){7.y(\'2P\').1v(3(){7.s(\'2P\')})}G=M.z(\'c-G\')==\'1\'?0:1;1t.3m(2.o,G,3(2I){M.3u(\'20\').z("c-G",2I?"1":0)})});5(f.3o()){$(\'#1j-2K\').a(3(){$(\'#1Z\').3p(3I)});$(\'#1Z\').a(3(){$(\'#1Z\').N()})}t{$(\'#1j-2K\').a(3(){5(f.4d()){L}15.P("请复制链接发送给好友")})}5(2.1Y){f.1c(\'13/h/4a\',{K:2.o},3(l){b d=l.d;$(".k-7-X[c-T=\'22\']").e(\'.D\').6(d.D.22);$(".k-7-X[c-T=\'2u\']").e(\'.D\').6(d.D.2u);$(".k-7-X[c-T=\'2t\']").e(\'.D\').6(d.D.2t);$(".k-7-X[c-T=\'2g\']").e(\'.D\').6(d.D.2g);$(".k-7-X[c-T=\'2f\']").e(\'.D\').6(d.D.2f);5(l.1e==1&&d.j.v>0){2.2D();$(\'#2i\').m();f.1K(\'#g-4\',\'4k\',l.d);$(\'#g-4 .k-2d:2Y-2Z\').a(3(){$("#2i").a()});$(\'#g-4\').2k()};f.1L(\'#g-4 .2h.V V\')})}$(\'.Q-8\').2e({4l:3(){$(".1I-h").6("<i 1B=\'7 7-3e\'></i> <F>释放查看图文详情</F>")},2L:3(){$(".1I-h").6("<i 1B=\'7 7-3c\'></i> <F>上拉查看图文详情</F>");$(\'.Q-8\').2e(\'2X\');2.1O();$(\'#B .B.W\').s(\'W\');$(\'#B .B:4i(1)\').y(\'W\')}});5(4g(1g.O)!==\'4h\'){9.45(1g.O)};f.1L(\'.13-2c .k-2c-12 V\');$(".k-2d-3V").a(3(){2.U=1f 1G({r:$(\'#25-9-2\').6(),1w:\'9-2\',1F:3(){2.U.p()}});2.U.4.e(\'.1j-11\').a(3(){2.U.p()});2.U.m();b q=$("#q").18();$(".25-12").3S(3(){5($(u).18()==q){$(u).3P("3Q","C")}});$(".25-12").1x("a",3(){$.1S({1T:f.1y(\'13/h/3W\',{K:$(u).18()}),2r:C,2s:3(c){c=1g.3X.43(c);5(c.1e>0){$("#q").18(c.d.K);$("#44").1J(c.d.42)}}})})})};2.U=3(){2.U=1f 1G({r:$(\'#1U-9-2\').6(),1w:\'9-2\',1F:3(){2.3Z.p()}})};2.3a=3(){5($(\'.h-8\').e(\'.r-8\').6()!=\'\'){L}15.2p.m(\'40\');$.1S({1T:f.1y(\'13/h/3U\',{K:2.o}),2r:C,2s:3(6){15.2p.N();b 2o=$(\'.h-8\').27(\'23\');$(\'.h-8\').e(\'.r-8\').27(\'23\',2o).6(6);4j(3(){$(\'.h-8\').2k();$(\'.h-8\').e(\'.r-8\').27(\'23\',\'48\');f.1L(\'.r-8 V\');b $6=$(6).e(\'V\');5($6.v>0){4c(b i=0,2m=$6.v;i<2m;i++){$6[i].3i=3(){b $u=$(u);b Z=$u.z(\'c-2Q\');5(!$u.z(\'3d-1q\')&&(Z.1X(\'3l://\')>-1||Z.1X(\'3j://\')>-1)){b 1q=Z.1X(2.1b)==-1?Z.2n(2.1s,2.1b):Z.2n(2.1b,2.1s);$u.z(\'c-2Q\',1q);$u.z(\'3d-1q\',C)}}}}},21);$(\'.h-8\').39({49:3(){$(".1I-Q").6("<i 1B=\'7 7-3c\'></i> <F>释放返回商品详情</F>")},46:3(){$(".1I-Q").6("<i 1B=\'7 7-3e\'></i> <F>下拉返回商品详情</F>");$(\'.Q-8\').m();$(\'.h-8\').s(\'H\').39(\'2X\');$(\'#B .B.W\').s(\'W\');$(\'#B .B:2Y-2Z\').y(\'W\')}})}})};2.1O=3(){$(\'.Q-8\').N();2.3a();$(\'.h-8\').1z(2T).y(\'H\').1v(3(){$(\'.h-8\').1z(\'\')})};2.1R=3(){$(\'.Q-8\').m();$(\'.h-8\').1z(2T).s(\'H\').1v(3(){$(\'.h-8\').1z(\'\')})};2.2U=3(){$(\'.30-8\').m().y(\'H\')};2.1C=3(){$(\'.30-8\').s(\'H\')};2.1D=3(1a){9.3n({o:2.o,n:2.n,3q:\';\',1a:1a,w:2.w,3r:C,3v:1M,31:2.31,37:2.37,3k:3(n,w,35){2.n=n;2.w=w;$(\'.1U-36\').6("已选: 数量x"+n+" "+35);5(1a==\'32\'){b q=$("#q").18();5($("#q")&&q==\'\'){15.P("请选择赠品！");$(".9-2").3M()}t{5($(\'.E-4\').v>0){b I=E.38(\'.E-4\');5(!I){L}t{f.1c(\'1r/1p/E\',{K:2.o,I:I},3(l){$.33.34(f.1y(\'1r/1p\',{K:2.o,w:2.w,n:2.n,3L:l.d.3B,q:q}),C)},C,C);9.p()}}t{9.p();$.33.34(f.1y(\'1r/1p\',{K:2.o,w:2.w,n:2.n,q:q}),1M)}}}t 5(1a==\'R\'){5($(\'.E-4\').v>0){b I=E.38(\'.E-4\');5(!I){L}t{f.1c(\'1r/1p/E\',{K:2.o,I:I},3(l){R.2W(2.o,2.w,2.n,I,3(l){$(\'.R-12\').e(\'.2l\').6(l.O).s(\'2R\').y(\'H\');1g.O=l.O})},C,C);9.p()}}t{R.2W(2.o,2.w,2.n,1M,3(l){$(\'.R-12\').e(\'.2l\').6(l.O).s(\'2R\').y(\'H\');1g.O=l.O});9.p()}}t{9.p()}}})};2.2J=3(){$(\'.1H-8\').m().y(\'H\').1v(3(){5(!$(\'.1H-8\').z(\'2z\')){$(\'.1H-8\').z(\'2z\',1);2.1l()}})};2.1d=3(){$(\'.1H-8\').s(\'H\')};2.2D=3(){2.Y=1;2.1Q=\'\';2.1N=1;$(\'.k-r\').1i({2L:3(){2.1l()}});5(2.Y==1){2.1l()}};2.1l=3(){$(\'#g-j-4 .r-1V\').N();$(\'#g-j-4 .1i-4b\').m();f.1c(\'13/h/3g\',{K:2.o,3O:2.Y,T:2.1Q,3w:2.1N},3(l){b d=l.d;5(d.n<=0){$(\'#g-j-4 .4\').6(\'\').N();$(\'#g-j-4 .r-1V\').m();$(\'#g-j-4\').1i(\'3b\')}t{$(\'#g-j-4 .4\').m();$(\'#g-j-4 .r-1V\').N();$(\'#g-j-4\').1i(\'1W\');5(d.j.v<=0||d.j.v<d.3T){$(\'#g-j-4\').1i(\'3b\')}}2.1N=0;2.Y++;f.1K(\'#g-j-4 .4\',\'4e\',d,2.Y>1);$(\'#g-j-4 .k-7-2q .k-7-X\').3Y(\'a\').a(3(){$(\'#g-j-4 .k-7-2q .k-7-X F.1J-11\').s(\'1J-11\');$(u).e(\'F\').y(\'1J-11\');2.Y=1;2.1N=1;2.1Q=$(u).c(\'T\');$(\'#g-j-4 .4\').6(\'\');2.1l()});f.1L(\'#g-22 .2h.V V\')},1M)};2.2V=3(2j){b S=1m(2j);b J=0;b 1h=0;5(S>16){J=1m(S/16);S=1m(S%16);5(J>16){1h=1m(J/16);J=1m(J%16)}}L{\'2b\':1h<10?\'0\'+1h:1h,\'24\':J<10?\'0\'+J:J,\'1P\':S<10?\'0\'+S:S}};2.2S=3(){b 4=$(\'.28-4\'),29=4.c(\'29\'),2a=4.c(\'2a\'),1e=4.c(\'1e\')||0;$.1S({1T:\'../3H/3J/41.1c\',47:3(x){3R=+1f 2M(x.4f("2M"))/21;5(1e==0){2.19=2a}t{2.19=29}3h(2.1o);2.26();2.1o=2.2H()}})};2.26=3(){2.19-=1;b 1A=2.2V(2.19);b 1E=$(\'.28-4\');1E.e(\'.17-2b\').6(1A.2b);1E.e(\'.17-24\').6(1A.24);1E.e(\'.17-1P\').6(1A.1P);5(2.19<=0){1n.1k()}};2.2H=3(){L 3t(3(){2.26()},21)};L 2});',62,270,'||modal|function|container|if|html|icon|block|picker|click|var|data|result|find|core|comments|detail||list|fui|ret|show|total|goodsid|close|giftid|content|removeClass|else|this|length|optionid||addClass|attr|salePicker|tab|true|count|diyform|span|isfavorite|in|diyformdata|theTime1|id|return|self|hide|cartcount|alert|basic|cart|theTime|level|giftPicker|img|active|col|commentPage|data_lazy||danger|item|goods|params|FoxUI|60|time|val|lasttime|action|attachurl_local|json|hideComment|status|new|window|theTime2|infinite|btn|reload|getCommentList|parseInt|location|timer|create|src|order|attachurl_remote|favorite|biz|transitionEnd|extraClass|on|getUrl|transition|times|class|hideParams|optionPicker|obj|maskClick|FoxUIModal|comment|look|text|tpl|showImages|false|commentCount|showDetail|sec|commentLevel|hideDetail|ajax|url|option|empty|init|indexOf|getComments|cover|submit|1000|all|height|min|gift|setSeckillTimer|css|seckill|starttime|endtime|hour|swipe|cell|pullToLoading|pic|bad|remark|tabcomment|value|lazyload|badge|len|replace|detailHeight|loader|group|cache|success|normal|good|bottom|buttons|discount|labeltext|loaded|sale|member|seckillinfo|initComment|city|onEnd|onStart|setSeckillTimerInterval|is|showComment|share|onLoading|Date|like|likefill|fav|lazy|out|initSeckill|300|showParams|formatSeconds|add|done|first|child|param|mustbind|buy|router|load|optiontitle|selector|backurl|getData|pullToRefresh|getDetail|stop|fold|check|unfold|toggleClass|get_comment_list|clearInterval|onerror|https|onConfirm|http|toggle|open|isWeixin|fadeIn|split|showConfirm|presell|setInterval|removeAttr|autoClose|getcount|tab1|tab2|tab3|handlers|goods_data_id|define|plugin|tab4|mask|cartbtn|addons|200|ewei_shopv2|according|gdid|remove|buybtn|page|prop|checked|currenttime|each|pagesize|get_detail|giftclick|querygift|JSON|unbind|packagePicker|mini|map|title|parse|gifttitle|changeCartcount|onRefresh|complete|auto|onRefreshReady|get_comments|loading|for|ish5app|tpl_goods_detail_comments_list|getResponseHeader|typeof|undefined|eq|setTimeout|tpl_goods_detail_comments|onLoadingReady'.split('|'),0,{}))



define(['core', 'tpl', 'biz/goods/picker', 'biz/member/favorite', 'biz/member/cart', 'biz/plugin/diyform'], function (core, tpl, picker, favorite, cart, diyform) {
    var modal = {};
    modal.init = function (params) {
        modal.seckillinfo = params.seckillinfo;
        modal.goodsid = params.goodsid;
        modal.optionid = 0;
        modal.total = 1;
        modal.getComments = params.getComments;
        modal.attachurl_local = params.attachurl_local;
        modal.attachurl_remote = params.attachurl_remote;
        FoxUI.tab({
            container: $('#tab'),
            handlers: {
                tab1: function () {
                    $('.basic-block').show();
                    modal.hideDetail();
                    modal.hideParams();
                    modal.hideComment()
                },
                tab2: function () {
                    modal.hideParams();
                    modal.hideComment();
                    modal.showDetail()
                },
                tab3: function () {
                    modal.showParams();
                    modal.hideComment()
                },
                tab4: function () {
                    modal.showComment()
                }
            }
        });
        modal.hideDetail();
        modal.hideParams();
        modal.hideComment();
        $('.option-selector').click(function () {
            modal.optionPicker('')
        });
        $('#alert-click').on("click", function () {
            $("#alert-picker").show()
        });
        $('.alert-close').on("click", function () {
            $("#alert-picker").hide()
        });
        $('#alert-mask').on("click", function () {
            $("#alert-picker").hide()
        });
        $('#city-picker').click(function () {
            modal.salePicker = new FoxUIModal({
                content: $('#city-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function () {
                    modal.salePicker.close()
                }
            });
            modal.salePicker.container.find('.btn-danger').click(function () {
                modal.salePicker.close()
            });
            modal.salePicker.show()
        });
        $('#sale-picker').click(function () {
            modal.salePicker = new FoxUIModal({
                content: $('#sale-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function () {
                    modal.salePicker.close()
                }
            });
            FoxUI.according.init();
            modal.salePicker.container.find('.btn-danger').click(function () {
                modal.salePicker.close()
            });
            modal.salePicker.show()
        });
        $(".bottom-buttons .cartbtn").click(function () {
            modal.optionPicker('cart')
        });
        $(".bottom-buttons .buybtn").click(function () {
            modal.optionPicker('buy')
        });
        if ($('#time-container').length > 0 || $('#discount-container').length > 0) {
            $('.fui-labeltext').timer({
                onEnd: function () {
                    location.reload()
                },
                onStart: function () {
                    location.reload()
                }
            })
        } else if ($('#time-presell').length > 0 || $('#discount-container').length > 0) {
            $('.fui-labeltext').timer({
                onEnd: function () {
                    location.reload()
                },
                onStart: function () {
                    location.reload()
                }
            })
        } else if ($('.seckill-container').length > 0) {
            modal.initSeckill()
        }
        $('.favorite-item').click(function () {
            var self = $(this);
            if (self.attr('submit') == '1') {
                return
            }
            self.attr('submit', 1);
            var isfavorite = self.attr('data-isfavorite') == '1';
            var icon = self.find('.icon');
            icon.removeClass('icon-like').removeClass('icon-likefill');
            isfavorite && icon.addClass('icon-like');
            !isfavorite && icon.addClass('icon-likefill');
            self.toggleClass('active');
            if (!isfavorite) {
                icon.addClass('fav').transitionEnd(function () {
                    icon.removeClass('fav')
                })
            }
            isfavorite = self.attr('data-isfavorite') == '1' ? 0 : 1;
            favorite.toggle(modal.goodsid, isfavorite, function (is) {
                self.removeAttr('submit').attr("data-isfavorite", is ? "1" : 0)
            })
        });
        if (core.isWeixin()) {
            $('#btn-share').click(function () {
                $('#cover').fadeIn(200)
            });
            $('#cover').click(function () {
                $('#cover').hide()
            })
        } else {
            $('#btn-share').click(function () {
                if (core.ish5app()) {
                    return
                }
                FoxUI.alert("请复制链接发送给好友")
            })
        }
        if (modal.getComments) {
            core.json('goods/detail/get_comments', {
                id: modal.goodsid
            }, function (ret) {
              console.info(ret);
                var result = ret.result;
                $(".fui-icon-col[data-level='all']").find('.count').html(result.count.all);
                $(".fui-icon-col[data-level='good']").find('.count').html(result.count.good);
                $(".fui-icon-col[data-level='normal']").find('.count').html(result.count.normal);
                $(".fui-icon-col[data-level='bad']").find('.count').html(result.count.bad);
                $(".fui-icon-col[data-level='pic']").find('.count').html(result.count.pic);
                if (ret.status == 1 && result.list.length > 0) {
                    modal.initComment();
                    $('#tabcomment').show();
                    core.tpl('#comments-container', 'tpl_goods_detail_comments', ret.result);
                    $('#comments-container .fui-cell:first-child').click(function () {
                        $("#tabcomment").click()
                    });
                    $('#comments-container').lazyload()
                };
                core.showImages('#comments-container .remark.img img')
            })
        }
        $('.basic-block').pullToLoading({
            onLoadingReady: function () {
                $(".look-detail").html("<i class='icon icon-unfold'></i> <span>释放查看图文详情</span>")
            },
            onLoading: function () {
                $(".look-detail").html("<i class='icon icon-fold'></i> <span>上拉查看图文详情</span>");
                $('.basic-block').pullToLoading('done');
                modal.showDetail();
                $('#tab .tab.active').removeClass('active');
                $('#tab .tab:eq(1)').addClass('active')
            }
        });
        if (typeof(window.cartcount) !== 'undefined') {
            picker.changeCartcount(window.cartcount)
        };
        core.showImages('.goods-swipe .fui-swipe-item img');
        $(".fui-cell-giftclick").click(function () {
            modal.giftPicker = new FoxUIModal({
                content: $('#gift-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function () {
                    modal.giftPicker.close()
                }
            });
            modal.giftPicker.container.find('.btn-danger').click(function () {
                modal.giftPicker.close()
            });
            modal.giftPicker.show();
            var giftid = $("#giftid").val();
            $(".gift-item").each(function () {
                if ($(this).val() == giftid) {
                    $(this).prop("checked", "true")
                }
            });
            $(".gift-item").on("click", function () {
                $.ajax({
                    url: core.getUrl('goods/detail/querygift', {
                        id: $(this).val()
                    }),
                    cache: true,
                    success: function (data) {
                        data = window.JSON.parse(data);
                        if (data.status > 0) {
                            $("#giftid").val(data.result.id);
                            $("#gifttitle").text(data.result.title)
                        }
                    }
                })
            })
        })
    };
    modal.giftPicker = function () {
        modal.giftPicker = new FoxUIModal({
            content: $('#option-picker-modal').html(),
            extraClass: 'picker-modal',
            maskClick: function () {
                modal.packagePicker.close()
            }
        })
    };
    modal.getDetail = function () {
        if ($('.detail-block').find('.content-block').html() != '') {
            return
        }
        FoxUI.loader.show('mini');
        $.ajax({
            url: core.getUrl('goods/detail/get_detail', {
                id: modal.goodsid
            }),
            cache: true,
            success: function (html) {
                FoxUI.loader.hide();
                var detailHeight = $('.detail-block').css('height');
                $('.detail-block').find('.content-block').css('height', detailHeight).html(html);
                setTimeout(function () {
                    $('.detail-block').lazyload();
                    $('.detail-block').find('.content-block').css('height', 'auto');
                    core.showImages('.content-block img');
                    var $html = $(html).find('img');
                    if ($html.length > 0) {
                        for (var i = 0, len = $html.length; i < len; i++) {
                            $html[i].onerror = function () {
                                var $this = $(this);
                                var data_lazy = $this.attr('data-lazy');
                                if (!$this.attr('check-src') && (data_lazy.indexOf('http://') > -1 || data_lazy.indexOf('https://') > -1)) {
                                    var src = data_lazy.indexOf(modal.attachurl_local) == -1 ? data_lazy.replace(modal.attachurl_remote, modal.attachurl_local) : data_lazy.replace(modal.attachurl_local, modal.attachurl_remote);
                                    $this.attr('data-lazy', src);
                                    $this.attr('check-src', true)
                                }
                            }
                        }
                    }
                }, 1000);
                $('.detail-block').pullToRefresh({
                    onRefreshReady: function () {
                        $(".look-basic").html("<i class='icon icon-fold'></i> <span>释放返回商品详情</span>")
                    },
                    onRefresh: function () {
                        $(".look-basic").html("<i class='icon icon-unfold'></i> <span>下拉返回商品详情</span>");
                        $('.basic-block').show();
                        $('.detail-block').removeClass('in').pullToRefresh('done');
                        $('#tab .tab.active').removeClass('active');
                        $('#tab .tab:first-child').addClass('active')
                    }
                })
            }
        })
    };
    modal.showDetail = function () {
        $('.basic-block').hide();
        modal.getDetail();
        $('.detail-block').transition(300).addClass('in').transitionEnd(function () {
            $('.detail-block').transition('')
        })
    };
    modal.hideDetail = function () {
        $('.basic-block').show();
        $('.detail-block').transition(300).removeClass('in').transitionEnd(function () {
            $('.detail-block').transition('')
        })
    };
    modal.showParams = function () {
        $('.param-block').show().addClass('in')
    };
    modal.hideParams = function () {
        $('.param-block').removeClass('in')
    };
    modal.optionPicker = function (action) {
        picker.open({
            goodsid: modal.goodsid,
            total: modal.total,
            split: ';',
            action: action,
            optionid: modal.optionid,
            showConfirm: true,
            autoClose: false,
            mustbind: modal.mustbind,
            backurl: modal.backurl,
            onConfirm: function (total, optionid, optiontitle) {
                modal.total = total;
                modal.optionid = optionid;
                $('.option-selector').html("已选: 数量x" + total + " " + optiontitle);
                if (action == 'buy') {
                    var giftid = $("#giftid").val();
                    if ($("#giftid") && giftid == '') {
                        FoxUI.alert("请选择赠品！");
                        $(".picker-modal").remove()
                    } else {
                        if ($('.diyform-container').length > 0) {
                            var diyformdata = diyform.getData('.diyform-container');
                            if (!diyformdata) {
                                return
                            } else {
                                core.json('order/create/diyform', {
                                    id: modal.goodsid,
                                    diyformdata: diyformdata
                                }, function (ret) {
                                    $.router.load(core.getUrl('order/create', {
                                        id: modal.goodsid,
                                        optionid: modal.optionid,
                                        total: modal.total,
                                        gdid: ret.result.goods_data_id,
                                        giftid: giftid
                                    }), true)
                                }, true, true);
                                picker.close()
                            }
                        } else {
                            picker.close();
                            $.router.load(core.getUrl('order/create', {
                                id: modal.goodsid,
                                optionid: modal.optionid,
                                total: modal.total,
                                giftid: giftid
                            }), false)
                        }
                    }
                } else if (action == 'cart') {
                    if ($('.diyform-container').length > 0) {
                        var diyformdata = diyform.getData('.diyform-container');
                        if (!diyformdata) {
                            return
                        } else {
                            core.json('order/create/diyform', {
                                id: modal.goodsid,
                                diyformdata: diyformdata
                            }, function (ret) {
                                cart.add(modal.goodsid, modal.optionid, modal.total, diyformdata, function (ret) {
                                    $('.cart-item').find('.badge').html(ret.cartcount).removeClass('out').addClass('in');
                                    window.cartcount = ret.cartcount
                                })
                            }, true, true);
                            picker.close()
                        }
                    } else {
                        cart.add(modal.goodsid, modal.optionid, modal.total, false, function (ret) {
                            $('.cart-item').find('.badge').html(ret.cartcount).removeClass('out').addClass('in');
                            window.cartcount = ret.cartcount
                        });
                        picker.close()
                    }
                } else {
                    picker.close()
                }
            }
        })
    };
    modal.showComment = function () {
        $('.comment-block').show().addClass('in').transitionEnd(function () {
            if (!$('.comment-block').attr('loaded')) {
                $('.comment-block').attr('loaded', 1);
                modal.getCommentList()
            }
        })
    };
    modal.hideComment = function () {
        $('.comment-block').removeClass('in')
    };
    modal.initComment = function () {
        modal.commentPage = 1;
        modal.commentLevel = '';
        modal.commentCount = 1;
        $('.fui-content').infinite({
            onLoading: function () {
                modal.getCommentList()
            }
        });
        if (modal.commentPage == 1) {
            modal.getCommentList()
        }
    };
    modal.getCommentList = function () {
        $('#comments-list-container .content-empty').hide();
        $('#comments-list-container .infinite-loading').show();
        core.json('goods/detail/get_comment_list', {
            id: modal.goodsid,
            page: modal.commentPage,
            level: modal.commentLevel,
            getcount: modal.commentCount
        }, function (ret) {
            var result = ret.result;
            if (result.total <= 0) {
                $('#comments-list-container .container').html('').hide();
                $('#comments-list-container .content-empty').show();
                $('#comments-list-container').infinite('stop')
            } else {
                $('#comments-list-container .container').show();
                $('#comments-list-container .content-empty').hide();
                $('#comments-list-container').infinite('init');
                if (result.list.length <= 0 || result.list.length < result.pagesize) {
                    $('#comments-list-container').infinite('stop')
                }
            }
            modal.commentCount = 0;
            modal.commentPage++;
            core.tpl('#comments-list-container .container', 'tpl_goods_detail_comments_list', result, modal.commentPage > 1);
            $('#comments-list-container .fui-icon-group .fui-icon-col').unbind('click').click(function () {
                $('#comments-list-container .fui-icon-group .fui-icon-col span.text-danger').removeClass('text-danger');
                $(this).find('span').addClass('text-danger');
                modal.commentPage = 1;
                modal.commentCount = 1;
                modal.commentLevel = $(this).data('level');
                $('#comments-list-container .container').html('');
                modal.getCommentList()
            });
            core.showImages('#comments-all .remark.img img')
        }, false)
    };
    modal.formatSeconds = function (value) {
        var theTime = parseInt(value);
        var theTime1 = 0;
        var theTime2 = 0;
        if (theTime > 60) {
            theTime1 = parseInt(theTime / 60);
            theTime = parseInt(theTime % 60);
            if (theTime1 > 60) {
                theTime2 = parseInt(theTime1 / 60);
                theTime1 = parseInt(theTime1 % 60)
            }
        }
        return {
            'hour': theTime2 < 10 ? '0' + theTime2 : theTime2,
            'min': theTime1 < 10 ? '0' + theTime1 : theTime1,
            'sec': theTime < 10 ? '0' + theTime : theTime
        }
    };
    modal.initSeckill = function () {
        var container = $('.seckill-container'),
            starttime = container.data('starttime'),
            endtime = container.data('endtime'),
            status = container.data('status') || 0;
        $.ajax({
                url: '../addons/ewei_shopv2/map.json',
                complete: function (x) {
                    currenttime = +new Date(x.getResponseHeader("Date")) / 1000;
                    if (status == 0) {
                        modal.lasttime = endtime
                    } else {
                        modal.lasttime = starttime
                    }
                    clearInterval(modal.timer);
                    modal.setSeckillTimer();
                    modal.timer = modal.setSeckillTimerInterval()
                }
            })
    };
    modal.setSeckillTimer = function () {
        modal.lasttime -= 1;
        var times = modal.formatSeconds(modal.lasttime);
        var obj = $('.seckill-container');
        obj.find('.time-hour').html(times.hour);
        obj.find('.time-min').html(times.min);
        obj.find('.time-sec').html(times.sec);
        if (modal.lasttime <= 0) {
            location.reload()
        }
    };
    modal.setSeckillTimerInterval = function () {
        return setInterval(function () {
            modal.setSeckillTimer()
        }, 1000)
    };
    return modal
});
